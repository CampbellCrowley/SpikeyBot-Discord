<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>SpikeyBot-Discord Source: src/moderation.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

	<link type="text/css" rel="stylesheet" href="styles/site.slate.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">SpikeyBot-Discord</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="module-lib_twemojiChecker.html">lib/twemojiChecker</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="ApiEndpoint.html">ApiEndpoint</a></li><li><a href="ApiRequestBody.html">ApiRequestBody</a></li><li><a href="BotCommands.html">BotCommands</a></li><li><a href="ChatBot.html">ChatBot</a></li><li><a href="CmdScheduling.html">CmdScheduling</a></li><li><a href="CmdScheduling-ScheduledCommand.html">CmdScheduling~ScheduledCommand</a></li><li><a href="Command.html">Command</a></li><li><a href="Command-CommandSetting.html">Command~CommandSetting</a></li><li><a href="Command-SingleCommand.html">Command~SingleCommand</a></li><li><a href="Common.html">Common</a></li><li><a href="Connect4.html">Connect4</a></li><li><a href="Connect4_Game.html">Connect4#Game</a></li><li><a href="CpuWatcher.html">CpuWatcher</a></li><li><a href="Define.html">Define</a></li><li><a href="DevCmds.html">DevCmds</a></li><li><a href="Echo.html">Echo</a></li><li><a href="Echo-Character.html">Echo~Character</a></li><li><a href="EE.html">EE</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="Events.html">Events</a></li><li><a href="FileServer.html">FileServer</a></li><li><a href="FunTranslators.html">FunTranslators</a></li><li><a href="HG.html">HG</a></li><li><a href="HGWeb.html">HGWeb</a></li><li><a href="HungryGames.html">HungryGames</a></li><li><a href="HungryGames-Action.html">HungryGames~Action</a></li><li><a href="HungryGames-ActionManager.html">HungryGames~ActionManager</a></li><li><a href="HungryGames-ActionStore.html">HungryGames~ActionStore</a></li><li><a href="HungryGames-Action-GiveRoleAction.html">HungryGames~Action~GiveRoleAction</a></li><li><a href="HungryGames-Action-RunCommandAction.html">HungryGames~Action~RunCommandAction</a></li><li><a href="HungryGames-Action-SendAutoplayingMessageAlertAction.html">HungryGames~Action~SendAutoplayingMessageAlertAction</a></li><li><a href="HungryGames-Action-SendDayEndMessageAction.html">HungryGames~Action~SendDayEndMessageAction</a></li><li><a href="HungryGames-Action-SendDayStartMessageAction.html">HungryGames~Action~SendDayStartMessageAction</a></li><li><a href="HungryGames-Action-SendEventMessageAction.html">HungryGames~Action~SendEventMessageAction</a></li><li><a href="HungryGames-Action-SendMessageAction.html">HungryGames~Action~SendMessageAction</a></li><li><a href="HungryGames-Action-SendPlayerRankMessageAction.html">HungryGames~Action~SendPlayerRankMessageAction</a></li><li><a href="HungryGames-Action-SendStatusListAction.html">HungryGames~Action~SendStatusListAction</a></li><li><a href="HungryGames-Action-SendTeamRankMessageAction.html">HungryGames~Action~SendTeamRankMessageAction</a></li><li><a href="HungryGames-Action-SendVictorAction.html">HungryGames~Action~SendVictorAction</a></li><li><a href="HungryGames-Action-TakeRoleAction.html">HungryGames~Action~TakeRoleAction</a></li><li><a href="HungryGames-ArenaEvent.html">HungryGames~ArenaEvent</a></li><li><a href="HungryGames-Battle.html">HungryGames~Battle</a></li><li><a href="HungryGames-ChannelAction.html">HungryGames~ChannelAction</a></li><li><a href="HungryGames-Day.html">HungryGames~Day</a></li><li><a href="HungryGames-DefaultOptions.html">HungryGames~DefaultOptions</a></li><li><a href="HungryGames-DefaultOptions-BooleanOption.html">HungryGames~DefaultOptions~BooleanOption</a></li><li><a href="HungryGames-DefaultOptions-NumberOption.html">HungryGames~DefaultOptions~NumberOption</a></li><li><a href="HungryGames-DefaultOptions-ObjectOption.html">HungryGames~DefaultOptions~ObjectOption</a></li><li><a href="HungryGames-DefaultOptions-Option.html">HungryGames~DefaultOptions~Option</a></li><li><a href="HungryGames-DefaultOptions-SelectOption.html">HungryGames~DefaultOptions~SelectOption</a></li><li><a href="HungryGames-Event.html">HungryGames~Event</a></li><li><a href="HungryGames-EventContainer.html">HungryGames~EventContainer</a></li><li><a href="HungryGames-FinalEvent.html">HungryGames~FinalEvent</a></li><li><a href="HungryGames-ForcedOutcome.html">HungryGames~ForcedOutcome</a></li><li><a href="HungryGames-Game.html">HungryGames~Game</a></li><li><a href="HungryGames-Grammar.html">HungryGames~Grammar</a></li><li><a href="HungryGames-GuildGame.html">HungryGames~GuildGame</a></li><li><a href="HungryGames-MemberAction.html">HungryGames~MemberAction</a></li><li><a href="HungryGames-Messages.html">HungryGames~Messages</a></li><li><a href="HungryGames-NormalEvent.html">HungryGames~NormalEvent</a></li><li><a href="HungryGames-OutcomeProbabilities.html">HungryGames~OutcomeProbabilities</a></li><li><a href="HungryGames-Player.html">HungryGames~Player</a></li><li><a href="HungryGames-Simulator.html">HungryGames~Simulator</a></li><li><a href="HungryGames-Simulator-Worker.html">HungryGames~Simulator~Worker</a></li><li><a href="HungryGames-StatGroup.html">HungryGames~StatGroup</a></li><li><a href="HungryGames-StatManager.html">HungryGames~StatManager</a></li><li><a href="HungryGames-Stats.html">HungryGames~Stats</a></li><li><a href="HungryGames-Team.html">HungryGames~Team</a></li><li><a href="HungryGames-UserIconUrl.html">HungryGames~UserIconUrl</a></li><li><a href="HungryGames-WeaponEvent.html">HungryGames~WeaponEvent</a></li><li><a href="Images.html">Images</a></li><li><a href="Main.html">Main</a></li><li><a href="MainModule.html">MainModule</a></li><li><a href="MemWatcher.html">MemWatcher</a></li><li><a href="MessageMaker.html">MessageMaker</a></li><li><a href="Messages.html">Messages</a></li><li><a href="Moderation.html">Moderation</a></li><li><a href="ModLog.html">ModLog</a></li><li><a href="ModLog-Settings.html">ModLog~Settings</a></li><li><a href="Music.html">Music</a></li><li><a href="NPC.html">NPC</a></li><li><a href="Patreon.html">Patreon</a></li><li><a href="Patreon-toExport.html">Patreon~toExport</a></li><li><a href="Pets.html">Pets</a></li><li><a href="Pets-BaseMoves.html">Pets~BaseMoves</a></li><li><a href="Pets-BasePetClasses.html">Pets~BasePetClasses</a></li><li><a href="Pets-BasePets.html">Pets~BasePets</a></li><li><a href="Pets-Constants.html">Pets~Constants</a></li><li><a href="Pets-NPC.html">Pets~NPC</a></li><li><a href="Pets-Pet.html">Pets~Pet</a></li><li><a href="Polling.html">Polling</a></li><li><a href="Polling-Poll.html">Polling~Poll</a></li><li><a href="RaidBlock.html">RaidBlock</a></li><li><a href="RaidBlock-RaidSettings.html">RaidBlock~RaidSettings</a></li><li><a href="RoleColors.html">RoleColors</a></li><li><a href="RoleManager.html">RoleManager</a></li><li><a href="Sandbox.html">Sandbox</a></li><li><a href="ShardingMaster.html">ShardingMaster</a></li><li><a href="ShardingMaster.ShardInfo.html">ShardingMaster.ShardInfo</a></li><li><a href="ShardingMaster.ShardMasterConfig.html">ShardingMaster.ShardMasterConfig</a></li><li><a href="ShardingMaster.ShardMasterConfig.HeartbeatConfig.html">ShardingMaster.ShardMasterConfig.HeartbeatConfig</a></li><li><a href="ShardingMaster.ShardMasterConfig.MailConfig.html">ShardingMaster.ShardMasterConfig.MailConfig</a></li><li><a href="ShardingMaster.ShardStatus.html">ShardingMaster.ShardStatus</a></li><li><a href="ShardingSlave.html">ShardingSlave</a></li><li><a href="SMLoader.html">SMLoader</a></li><li><a href="SpikeyBot.html">SpikeyBot</a></li><li><a href="Spotify.html">Spotify</a></li><li><a href="Strings.html">Strings</a></li><li><a href="Strings-Locale.html">Strings~Locale</a></li><li><a href="SubModule.html">SubModule</a></li><li><a href="TicTacToe.html">TicTacToe</a></li><li><a href="TicTacToe_Game.html">TicTacToe#Game</a></li><li><a href="TTS.html">TTS</a></li><li><a href="Twitch.html">Twitch</a></li><li><a href="Uno.html">Uno</a></li><li><a href="Uno_Card.html">Uno#Card</a></li><li><a href="Uno_Game.html">Uno#Game</a></li><li><a href="WebAccount.html">WebAccount</a></li><li><a href="WebApi.html">WebApi</a></li><li><a href="WebProxy.html">WebProxy</a></li><li><a href="WebSettings.html">WebSettings</a></li><li><a href="WebStats.html">WebStats</a></li><li><a href="WebUserData.html">WebUserData</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="global.html#__stack">__stack</a></li><li><a href="global.html#_handler">_handler</a></li><li><a href="global.html#_saveData">_saveData</a></li><li><a href="global.html#addListener">addListener</a></li><li><a href="global.html#clearEvent">clearEvent</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#createProxyServer">createProxyServer</a></li><li><a href="global.html#createRightProxy">createRightProxy</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#fmtLong">fmtLong</a></li><li><a href="global.html#fmtShort">fmtShort</a></li><li><a href="global.html#formatArgs">formatArgs</a></li><li><a href="global.html#hasPort">hasPort</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#inspectOpts">inspectOpts</a></li><li><a href="global.html#load">load</a></li><li><a href="global.html#localstorage">localstorage</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#plural">plural</a></li><li><a href="global.html#s">s</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#self">self</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#sqlCon">sqlCon</a></li><li><a href="global.html#tty">tty</a></li><li><a href="global.html#unhandledRejection">unhandledRejection</a></li><li><a href="global.html#useColors">useColors</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="external-Discord.html">Discord</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: src/moderation.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">// Copyright 2019 Campbell Crowley. All rights reserved.
// Author: Campbell Crowley (dev@campbellcrowley.com)
const fs = require('fs');
const SubModule = require('./subModule.js');
const diff = require('diff');

/**
 * @description Handle all moderator related commands and control.
 * @augments SubModule
 */
class Moderation extends SubModule {
  /**
   * Instantiate Moderation SubModule.
   */
  constructor() {
    super();
    /** @inheritdoc */
    this.myName = 'Moderation';
    /**
     * All guilds that have disabled the auto-smite feature.
     *
     * @private
     * @type {object.&lt;boolean>}
     */
    this._disabledAutoSmite = {};

    /**
     * All guilds that have disabled sending messages when someone is banned.
     *
     * @private
     * @type {object.&lt;boolean>}
     */
    this._disabledBanMessage = {};
    /**
     * The guilds with auto-smite enabled, and members who have mentioned
     * "@everyone", and the timestamps of these mentions.
     *
     * @private
     * @type {object.&lt;object.&lt;string>>}
     */
    this._mentionAccumulator = {};
    /**
     * All of the possible messages to show when using the ban command.
     *
     * @private
     * @type {string[]}
     * @constant
     */
    this._banMsgs = [
      'It was really nice meeting you!',
      'You\'re a really great person, I\'m sorry I had to do this.',
      'See you soon!',
      'And they were never heard from again...',
      'Poof! Gone like magic!',
      'Does it seem quiet in here? Or is it just me?',
      'And like the trash, they\'re were taken out!',
      'Looks like they made like a tree, and leaf-ed. (sorry)',
      'Oof! Looks like my boot to their behind left a mark!',
      'Between you and me, I didn\'t like them anyways.',
      'Everyone rejoice! The world has been eradicated of one more person ' +
          'that no one liked anyways.',
      'The ban hammer has spoken!',
    ];

    this.save = this.save.bind(this);
    this.muteMember = this.muteMember.bind(this);
    this._onMessageDelete = this._onMessageDelete.bind(this);
    this._onMessageUpdate = this._onMessageUpdate.bind(this);
    this._onMessageDeleteBulk = this._onMessageDeleteBulk.bind(this);
    this._onGuildMemberRemove = this._onGuildMemberRemove.bind(this);
    this._onGuildMemberAdd = this._onGuildMemberAdd.bind(this);
    this._commandKick = this._commandKick.bind(this);
  }
  /** @inheritdoc */
  initialize() {
    /**
     * Permissions required to to use the smite command. Bitfield.
     *
     * @private
     * @type {number}
     * @constant
     */
    this._smitePerms = this.Discord.Permissions.FLAGS.CONNECT |
        this.Discord.Permissions.FLAGS.VIEW_CHANNEL;

    /* const adminOnlyOpts = new this.command.CommandSetting({
      validOnlyInGuild: true,
      defaultDisabled: true,
      permissions: this.Discord.Permissions.FLAGS.MANAGE_ROLES |
          this.Discord.Permissions.FLAGS.MANAGE_GUILD |
          this.Discord.Permissions.FLAGS.BAN_MEMBERS,
    });

    this.command.on(
        new this.command.SingleCommand(['purge', 'prune'], commandPurge, {
          validOnlyInGuild: true,
          defaultDisabled: true,
          permissions: this.Discord.Permissions.FLAGS.MANAGE_MESSAGES,
        }));
    this.command.on(
        new this.command.SingleCommand(['ban', 'fuckyou'], commandBan, {
          validOnlyInGuild: true,
          defaultDisabled: true,
          permissions: this.Discord.Permissions.FLAGS.BAN_MEMBERS,
        }));
    this.command.on(new this.command.SingleCommand(['smite'], commandSmite, {
      validOnlyInGuild: true,
      defaultDisabled: true,
      permissions: this.Discord.Permissions.FLAGS.MANAGE_ROLES,
    }));
    this.command.on(
        new this.command.SingleCommand(
            'togglemute', commandToggleMute, adminOnlyOpts));
    this.command.on(
        new this.command.SingleCommand(
            'togglebanmessages', commandToggleBanMessages, adminOnlyOpts)); */
    this.command.on(
        new this.command.SingleCommand(['kick'], this._commandKick, {
          validOnlyInGuild: true,
          defaultDisabled: true,
          permissions: this.Discord.Permissions.FLAGS.KICK_MEMBERS,
        }));

    this.client.guilds.cache.forEach((g) => {
      if (!fs.existsSync(
          `${this.common.guildSaveDir}${g.id}/moderation.json`)) {
        // This is here to upgrade to new file-system. After first load
        // main-config.json does not need to be read anymore.
        fs.readFile(
            `${this.common.guildSaveDir}${g.id}/main-config.json`,
            (err, file) => {
              if (err) return;
              let parsed;
              try {
                parsed = JSON.parse(file);
              } catch (e) {
                return;
              }
              if (typeof parsed.disabledAutoSmite === 'boolean') {
                this._disabledAutoSmite[g.id] = parsed.disabledAutoSmite;
              }
              if (typeof parsed.disabledBanMessage === 'boolean') {
                this._disabledBanMessage[g.id] = parsed.disabledBanMessage;
              }
            });
      } else {
        fs.readFile(
            `${this.common.guildSaveDir}${g.id}/moderation.json`,
            (err, file) => {
              if (err) return;
              let parsed;
              try {
                parsed = JSON.parse(file);
              } catch (e) {
                return;
              }
              if (typeof parsed.disabledAutoSmite === 'boolean') {
                this._disabledAutoSmite[g.id] = parsed.disabledAutoSmite;
              }
              if (typeof parsed.disabledBanMessage === 'boolean') {
                this._disabledBanMessage[g.id] = parsed.disabledBanMessage;
              }
            });
      }
    });
    this.client.on('messageDelete', this._onMessageDelete);
    this.client.on('messageUpdate', this._onMessageUpdate);
    this.client.on('messageDeleteBulk', this._onMessageDeleteBulk);
    this.client.on('guildMemberRemove', this._onGuildMemberRemove);
    this.client.on('guildMemberAdd', this._onGuildMemberAdd);
  }
  /** @inheritdoc */
  shutdown() {
    /* this.command.removeListener('purge');
    this.command.removeListener('fuckyou');
    this.command.removeListener('smite');
    this.command.removeListener('togglemute');
    this.command.removeListener('togglebanmessages'); */
    this.command.removeListener('kick');
    this.client.removeListener('messageDelete', this._onMessageDelete);
    this.client.removeListener('messageUpdate', this._onMessageUpdate);
    this.client.removeListener('messageDeleteBulk', this._onMessageDeleteBulk);
    this.client.removeListener('guildMemberRemove', this._onGuildMemberRemove);
    this.client.removeListener('guildMemberAdd', this._onGuildMemberAdd);
  }
  /** @inheritdoc */
  save(opt) {
    if (!this.initialized) return;

    this.client.guilds.cache.forEach((obj) => {
      const dir = `${this.common.guildSaveDir}${obj.id}/`;
      const filename = `${dir}moderation.json`;
      const data = {
        disabledBanMessage: this._disabledBanMessage[obj.id],
        disabledAutoSmite: this._disabledAutoSmite[obj.id],
      };
      if (opt == 'async') {
        this.common.mkAndWrite(filename, dir, JSON.stringify(data));
      } else {
        this.common.mkAndWriteSync(filename, dir, JSON.stringify(data));
      }
    });
  }

  /**
   * @description Handle logging when a message is deleted.
   * @private
   * @param {external:Discord~Message} msg The deleted message.
   */
  _onMessageDelete(msg) {
    if (!msg.guild) return;
    if (msg.channel.id === this.common.testChannel) return;
    const modLog = this.bot.getSubmodule('./modLog.js');
    if (!modLog) return;
    const tag = msg.author.tag;
    const id = msg.author.id;
    const channel = msg.channel.name;
    if ((id == this.client.user.id || id == '318552464356016131') &amp;&amp;
        msg.content === '`Autoplaying...`') {
      return;
    }
    const files = msg.attachments.map((el) => el.url);
    if (msg.author.bot) {
      modLog.output(
          msg.guild, 'messageBotDelete', null, null,
          `${tag}'s (${id}) in #${channel}`, files.length > 0 ?
              `${msg.content.substr(0, 100)}\n\nFiles: ${files.join(' ')}` :
              msg.content);
    } else {
      modLog.output(
          msg.guild, 'messageDelete', null, null,
          `${tag}'s (${id}) in #${channel}`, files.length > 0 ?
              `${msg.content.substr(0, 100)}\n\nFiles: ${files.join(' ')}` :
              msg.content);
    }
  }
  /**
   * @description Handle logging when a message is edited.
   * @private
   * @param {external:Discord~Message} prev The previous message.
   * @param {external:Discord~Message} msg The new message.
   */
  _onMessageUpdate(prev, msg) {
    if (!msg.guild) return;
    if (msg.channel.id === this.common.testChannel) return;
    if (msg.author.id === this.client.user.id) return;
    const modLog = this.bot.getSubmodule('./modLog.js');
    if (!modLog) return;
    const tag = msg.author.tag;
    const id = msg.author.id;
    const channel = msg.channel.name;

    const diffs = diff.diffWords(prev.content, msg.content);
    let out = '';
    let diffOk = false;

    if (diffs.length > 0) {
      let last = null;
      for (let i = 0; i &lt; diffs.length; i++) {
        const d = diffs[i];
        if (!d.added &amp;&amp; !d.removed) {
          if (last) out += ']';
          if (d.count > 23) {
            if (last) out += '\n';
            if (last) {
              out += d.value.substr(0, 10).replace(/\n/g, '\\n') + '...';
              if (i != diffs.length - 1) {
                out += d.value.substr(-10).replace(/\n/g, ' ');
              }
            } else {
              out += d.value.substr(-23).replace(/\n/g, ' ');
            }
          } else if (d.value != ' ') {
            if (last) out += '\n';
            out += d.value.replace(/\n/g, '\\n');
          }
          last = null;
        } else if (d.added) {
          diffOk = true;
          if (last &amp;&amp; last != 'add') {
            out += ']\n+[';
          } else if (!last) {
            out += '\n+[';
          }
          out += `${d.value.replace(/\n/g, '\\n')}`;
          last = 'add';
        } else if (d.removed) {
          diffOk = true;
          if (last &amp;&amp; last != 'remove') {
            out += ']\n-[';
          } else if (!last) {
            out += '\n-[';
          }
          out += `${d.value.replace(/\n/g, '\\n')}`;
          last = true;
        }
      }
      if (last) out += ']';
    }
    if (!out || out.trim().length == 0) {
      out = '*[Embeds Updated]';
    }
    if (!diffOk) return;

    const preview = prev.content.length > 103 ?
        (prev.content.substr(0, 100) + '...') :
        prev.content;
    if (msg.author.bot) {
      modLog.output(
          msg.guild, 'messageBotUpdate', null, null,
          `${tag}'s (${id}) in #${channel} (ID: ${msg.id})`, preview, 'Diff',
          '```diff\n' + out + '```');
    } else {
      modLog.output(
          msg.guild, 'messageUpdate', null, null,
          `${tag}'s (${id}) in #${channel} (ID: ${msg.id})`, preview, 'Diff',
          '```diff\n' + out + '```');
    }
  }
  /**
   * @description Handle logging when multiple messages are deleted.
   * @private
   * @param {external:Discord~Collection&lt;external:Discord~Message>} msgs The
   * deleted messages.
   */
  _onMessageDeleteBulk(msgs) {
    const modLog = this.bot.getSubmodule('./modLog.js');
    if (!modLog) return;
    if (!modLog.getSettings(msgs.first().guild.id).check('messagePurge')) {
      return;
    }
    let channels = [];
    msgs.forEach((m) => {
      if (!channels.includes(`#${m.channel.name}`)) {
        channels.push(`#${m.channel.name}`);
      }
    });
    if (channels.length > 3) {
      channels = `${channels.length} channels`;
    } else {
      channels = channels.join(', ');
    }
    modLog.output(
        msgs.first().guild, 'messagePurge', null, null,
        `${msgs.size} messages deleted from ${channels}.`);
  }
  /**
   * @description Handle a guild member leaving the guild.
   * @private
   * @param {external:Discord~GuildMember} member The member that left or was
   * kicked.
   */
  _onGuildMemberRemove(member) {
    const modLog = this.bot.getSubmodule('./modLog.js');
    if (!modLog) return;
    const additional = member.joinedTimestamp &amp;&amp;
        this._formatDelay(Date.now() - member.joinedTimestamp);
    modLog.output(
        member.guild, 'memberLeave', member.user, null, 'Time on server',
        additional);
  }
  /**
   * @description Handle someone joining the guild.
   * @private
   * @param {external:Discord~GuildMember} member The member that joined.
   */
  _onGuildMemberAdd(member) {
    const modLog = this.bot.getSubmodule('./modLog.js');
    if (!modLog) return;
    if (!modLog.getSettings(member.guild.id).check('memberJoin')) return;
    let num = -1;
    if (this.client.shard) {
      const toEval =
      `this.guilds.cache.filter((g) => g.members.resolve('${member.id}')).size`;
      this.client.shard.broadcastEval(toEval)
          .then((res) => {
            res.forEach((el) => num += el);
            const additional = num > 0 ?
                `${num} other mutual server${num > 1 ? 's' : ''}.` :
                null;
            modLog.output(
                member.guild, 'memberJoin', member.user, null, additional);
          })
          .catch((err) => {
            this.error(
                'Failed to get mutual guild count: ' + member.guild.id + '@' +
                member.user.id);
            console.error(err);
            modLog.output(member.guild, 'memberJoin', member.user);
          });
    } else {
      this.client.guilds.cache.forEach((g) => {
        if (g.members.resolve(member.id)) num++;
      });
      const additional =
          num > 0 ? `${num} other mutual server${num > 1 ? 's' : ''}.` : null;
      modLog.output(member.guild, 'memberJoin', member.user, null, additional);
    }
  }

  /**
   * @description Give a guild member a muted role that prevents them from
   * talking in any channel in the guild.
   * @public
   * @param {external:Discord~GuildMember} member The member of the guild to
   * mute.
   * @param {Function} cb Callback function with a single argument which is a
   * string if there was an error, or null if success.
   */
  muteMember(member, cb) {
    let hasMuteRole = false;
    let muteRole;
    const toMute = member;
    member.guild.roles.cache.forEach((val) => {
      if (val.name == 'Muted') {
        hasMuteRole = true;
        muteRole = val;
      }
    });
    const self = this;
    const mute = function(role, member) {
      try {
        member.roles.add(role)
            .then(() => {
              cb();
            })
            .catch((err) => {
              self.error(
                  'Failed to mute member: ' + member.guild.id + '@' +
                  member.id);
              console.error(err);
              cb('Failed to give role');
            });
        member.guild.channels.cache.forEach((channel) => {
          if (channel.permissionsLocked) return;
          const overwrites = channel.permissionOverwrites.resolve(role.id);
          if (overwrites) {
            if (channel.type == 'category') {
              if (overwrites.deny.has(
                  self.Discord.Permissions.FLAGS.SEND_MESSAGES) &amp;&amp;
                  overwrites.deny.has(self.Discord.Permissions.FLAGS.SPEAK)) {
                return;
              }
            } else if (channel.type == 'text') {
              if (overwrites.deny.has(
                  self.Discord.Permissions.FLAGS.SEND_MESSAGES)) {
                return;
              }
            } else if (channel.type == 'voice') {
              if (overwrites.deny.has(self.Discord.Permissions.FLAGS.SPEAK)) {
                return;
              }
            }
          }
          channel.updateOverwrite(role, {SEND_MESSAGES: false, SPEAK: false})
              .catch(console.error);
        });
      } catch (err) {
        console.log(err);
        cb('Failed to manage role');
      }
    };
    if (!hasMuteRole) {
      member.guild.roles
          .create({
            data: {
              name: 'Muted',
              position: member.guild.me.roles.highest.position - 1,
              permissions: 0,
            },
          })
          .then((role) => {
            mute(role, toMute);
          })
          .catch((err) => {
            this.error(
                'Failed to create mute role in guild: ' + member.guild.id);
            console.error(err);
            cb('Failed to create role');
          });
    } else {
      mute(muteRole, toMute);
    }
  }

  /**
   * Kick a mentioed user (or role from ID) and send a message saying they were
   * banned.
   *
   * @private
   * @type {commandHandler}
   * @param {Discord~Message} msg Message that triggered command.
   * @listens Command#kick
   */
  _commandKick(msg) {
    const uIds = msg.text.match(/\d{17,19}/g);
    if (!uIds) {
      this.common.reply(
          msg, 'You must mention someone to kick or specify an ID of ' +
              'someone on the server.');
      return;
    }
    const banList = [];
    uIds.forEach((el) => {
      const u = msg.guild.members.resolve(el);
      if (u) {
        if (!banList.includes(u.id)) banList.push(u);
      } else {
        const r = msg.guild.roles.resolve(el);
        if (r) {
          r.members.forEach((m) => {
            if (!banList.includes(m.id)) banList.push(m);
          });
        }
      }
    });
    if (banList.length == 0) {
      this.common.reply(
          msg, 'You must mention someone to kick or specify an ID of ' +
              'someone on the server.');
      return;
    }
    let reason =
        msg.text.replace(this.Discord.MessageMentions.USERS_PATTERN, '')
            .replace(this.Discord.MessageMentions.ROLES_PATTERN, '')
            .replace(/\d{17,19}/g)
            .replace(/\s{2,}/g, ' ')
            .trim();
    if (reason == 'undefined') reason = null;
    banList.forEach((toBan) => {
      if (msg.guild.ownerID !== msg.author.id &amp;&amp;
          msg.member.roles.highest.comparePositionTo(toBan.roles.highest) &lt;=
              0) {
        this.common
            .reply(
                msg, 'You can\'t kick ' + toBan.user.username +
                    '! You are not stronger than them!')
            .catch(() => {});
      } else {
        const me = msg.guild.me;
        const myRole = me.roles.highest;
        const highest = toBan.roles.highest;

        if (!myRole || (highest &amp;&amp; myRole.comparePositionTo(highest) &lt;= 0)) {
          this.common
              .reply(
                  msg, 'I can\'t kick ' + toBan.user.username +
                      '! I am not strong enough!')
              .catch(() => {});
        } else {
          // const banMsg = banMsgs[Math.floor(Math.random() * banMsgs.length)];
          const banMsg = 'Kicked';
          toBan.kick({reason: reason || banMsg})
              .then(() => {
                this.common.reply(msg, banMsg, 'Kicked ' + toBan.user.username)
                    .catch(() => {});
                const modLog = this.bot.getSubmodule('./modLog.js');
                if (modLog) {
                  modLog.output(
                      msg.guild, 'kick', toBan.user, msg.author,
                      reason || banMsg);
                }
              })
              .catch((err) => {
                this.common
                    .reply(
                        msg, 'Oops! I wasn\'t able to kick ' +
                            toBan.user.username + '! I\'m not sure why though!')
                    .catch(() => {});
                this.error('Failed to kick user.');
                console.error(err);
              });
        }
      }
    });
  }
  /**
   * Format a duration in milliseconds into a human readable string.
   *
   * @private
   *
   * @param {number} msecs Duration in milliseconds.
   * @returns {string} Formatted string.
   */
  _formatDelay(msecs) {
    let output = '';
    let unit = 7 * 24 * 60 * 60 * 1000;
    if (msecs >= unit) {
      const num = Math.floor(msecs / unit);
      output += num + ' week' + (num == 1 ? '' : 's') + ', ';
      msecs -= num * unit;
    }
    unit /= 7;
    if (msecs >= unit) {
      const num = Math.floor(msecs / unit);
      output += num + ' day' + (num == 1 ? '' : 's') + ', ';
      msecs -= num * unit;
    }
    unit /= 24;
    if (msecs >= unit) {
      const num = Math.floor(msecs / unit);
      output += num + ' hour' + (num == 1 ? '' : 's') + ', ';
      msecs -= num * unit;
    }
    unit /= 60;
    if (msecs >= unit) {
      const num = Math.floor(msecs / unit);
      output += num + ' minute' + (num == 1 ? '' : 's') + ', ';
      msecs -= num * unit;
    }
    unit /= 60;
    if (msecs >= unit) {
      const num = Math.round(msecs / unit);
      output += num + ' second' + (num == 1 ? '' : 's') + '';
    }
    return output.replace(/,\s$/, '');
  }
}

module.exports = new Moderation();
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	<small>Website Contact: <a href="mailto:web@spikeybot.com">web@spikeybot.com</a>.</small><br><small>&copy; Copyright 2019-2020, Campbell Crowley. <a href="https://docs.google.com/document/d/1SAC2aPxxeNqRjlZzjwrnCyyWWyt09ZP-AP7BDBjjQDg/edit?usp=sharing">Privacy Policy</a></small>
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a>
	
		on Wednesday, April 15, 2020 1:07 PM (-07:00)
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->

<script>
	(function ( i, s, o, g, r, a, m ) {
		i['GoogleAnalyticsObject'] = r;
		i[r] = i[r] || function () {
			(i[r].q = i[r].q || []).push( arguments )
		}, i[r].l = 1 * new Date();
		a = s.createElement( o ),
			m = s.getElementsByTagName( o )[0];
		a.async = 1;
		a.src = g;
		m.parentNode.insertBefore( a, m )
	})( window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga' );

	ga( 'create', 'UA-89923351-1', 'www.spikeybot.com' );
	ga( 'send', 'pageview' );
</script>



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
